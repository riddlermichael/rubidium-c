set(THREADS_PREFER_PTHREAD_FLAG ON)
find_package(Threads REQUIRED)

if(DEFINED CMAKE_USE_PTHREADS_INIT)
    set(RBC_USE_PTHREADS 1)
    set(RBC_USE_WIN32_THREADS "(-1)")
    message(STATUS ">>> Thread model: pthreads")
elseif(DEFINED CMAKE_USE_WIN32_THREADS_INIT)
    set(RBC_USE_PTHREADS "(-1)")
    set(RBC_USE_WIN32_THREADS 1)
    message(STATUS ">>> Thread model: win32")
else()
    message(FATAL_ERROR "Unsupported thread library")
endif()

set(FEATURE_FILE "${GENERATED_INCLUDE_DIR}/rbc/sync.h")
file(WRITE ${FEATURE_FILE} "/*
 * This file is auto-generated.
 * Do not edit this file manually.
 * Do not include this file directly.
 */\n\n")

file(APPEND ${FEATURE_FILE} "#define RBC_USE_PTHREADS ${RBC_USE_PTHREADS}\n")
file(APPEND ${FEATURE_FILE} "#define RBC_USE_WIN32_THREADS ${RBC_USE_WIN32_THREADS}\n")

add_c_module(sync ${RBC_ROOT_DIR})
set(HEADERS "${HEADERS}" PARENT_SCOPE)
set(SOURCES "${SOURCES}" PARENT_SCOPE)
